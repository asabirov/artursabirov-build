<!DOCTYPE html>
<html dir='ltr' lang='ru-RU'>
  <head>
    <meta charset='utf-8'>
    <title>Selenium Server на CentOS</title>
    <link href='http://feeds.feedburner.com/artursabirov' rel='alternate' title='ArturSabirov.ru' type='application/rss+xml'>
    <link href="/stylesheets/blog.css" media="screen" rel="stylesheet" type="text/css" />
    <meta content='width=device-width, initial-scale=1.0' name='viewport'>
    <script charset='windows-1251' src='http://vkontakte.ru/js/api/openapi.js?29' type='text/javascript'></script>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="http://feeds.feedburner.com/artursabirov//dev" />
    <script>
      VK.init({apiId: 2348265, onlyWidgets: true});
    </script>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-24946626-1']);
      _gaq.push(['_trackPageview']);
      
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <header>
      <section>
        <h1 id='page_heading'>
          <a href='/'>Блог Артура Сабирова</a>
        </h1>
        <nav>
          <a href="/dev">Разработка</a>
          <a href="/projects">Проекты</a>
          <a href="/books">Обзор книг</a>
          <a href="/life">Жизнь</a>
          <a href="/about">О себе</a>
        </nav>
      </section>
    </header>
    <section id='single-column'>
      <article>
        <h1>Selenium Server на CentOS</h1>
        <h3 id="section">Установка</h3>
        
        <p>Для начала потребуется виртуальный буфер для эмуляции иксов.</p>
        
        <pre class="highlight plaintext">yum install Xvfb
        
        </pre>
        
        <p>Скрипт автозагрузки:</p>
        
        <pre class="highlight shell"><span class="c">#!/bin/bash</span>
        <span class="c">#</span>
        <span class="c"># /etc/rc.d/init.d/xvfbd</span>
        <span class="c">#</span>
        <span class="c"># chkconfig: 345 95 28</span>
        <span class="c"># description: Starts/Stops X Virtual Framebuffer server</span>
        <span class="c"># processname: Xvfb</span>
        <span class="c">#</span>
        
        . /etc/init.d/functions
        
        <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NETWORKING</span><span class="k">}</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"no"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0
        
        <span class="nv">PROG</span><span class="o">=</span><span class="s2">"Xvfb[
        PROG_OPTIONS=](7)
        -ac -screen 0 1024x768x24"</span>
        <span class="nv">PROG_OUTPUT</span><span class="o">=</span><span class="s2">"/tmp/Xvfb.out"</span>
        
        <span class="k">case</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="k">in
            </span>start<span class="p">)</span>
                <span class="nb">echo</span> -n <span class="s2">"Starting : X Virtual Frame Buffer "</span>
                <span class="nv">$PROG</span> <span class="nv">$PROG_OPTIONS</span>&gt;&gt;<span class="nv">$PROG_OUTPUT</span> 2&gt;&amp;1 &amp;
                <span class="nb">disown</span> -ar
                /bin/usleep 500000
                status Xvfb &amp; &gt;/dev/null <span class="o">&amp;&amp;</span> echo_success <span class="o">||</span> echo_failure
                <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
                <span class="k">if</span> <span class="o">[</span> <span class="nv">$RETVAL</span> -eq 0 <span class="o">]</span>; <span class="k">then</span>
                    /bin/touch /var/lock/subsys/Xvfb
                    /sbin/pidof -o  %PPID -x Xvfb &gt; /var/run/Xvfb.pid
                <span class="k">fi
                </span><span class="nb">echo</span>
           		<span class="p">;;</span>
            stop<span class="p">)</span>
                <span class="nb">echo</span> -n <span class="s2">"Shutting down : X Virtual Frame Buffer"</span>
                killproc <span class="nv">$PROG</span>
                <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
                <span class="o">[</span> <span class="nv">$RETVAL</span> -eq 0 <span class="o">]</span> <span class="o">&amp;&amp;</span> /bin/rm -f /var/lock/subsys/Xvfb /var/run/Xvfb.pid
                <span class="nb">echo</span>
                <span class="p">;;</span>
            restart|reload<span class="p">)</span>
            	<span class="nv">$0</span> stop
            	<span class="nv">$0</span> start
                <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
              	<span class="p">;;</span>
            status<span class="p">)</span>
            	status Xvfb
            	<span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
            	<span class="p">;;</span>
            <span class="k">*</span><span class="p">)</span>
             <span class="nb">echo</span> <span class="s2">$"Usage: </span><span class="nv">$0</span><span class="s2"> (start|stop|restart|reload|status)"</span>
             <span class="nb">exit </span>1
        <span class="k">esac
        
        </span><span class="nb">exit</span> <span class="nv">$RETVAL</span>
        
        </pre>
        
        <p>Добавим его в автозагрузку и запустим.</p>
        
        <pre class="highlight shell">chmod +x /etc/init.d/xvfb
        chkconfig xvfb on
        service xvfb start
        
        </pre>
        
        <p>Таперь Selenium Server.</p>
        
        <pre class="highlight shell">mkdir /usr/local/lib/selenium
        <span class="nb">cd</span> /usr/local/lib/selenium
        wget http://selenium.googlecode.com/files/selenium-server-standalone-2.4.0.jar
        mkdir -p /var/log/selenium/
        chmod a+w /var/log/selenium/
        
        </pre>
        
        <p>/etc/init.d/selenium</p>
        
        <pre class="highlight shell"><span class="c">#!/bin/bash</span>
        
        <span class="k">case</span> <span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="s1">''</span><span class="k">}</span><span class="s2">"</span> <span class="k">in</span>
            <span class="s1">'start'</span><span class="p">)</span>
                <span class="k">if </span><span class="nb">test</span> -f /tmp/selenium.pid
                <span class="k">then
                    </span><span class="nb">echo</span> <span class="s2">"Selenium is already running."</span>
                <span class="k">else
                    </span><span class="nv">DISPLAY</span><span class="o">=</span>:7 java -jar /usr/local/lib/selenium/selenium-server-standalone-2.4.0.jar -port 4444 &gt; /var/log/selenium/selenium-output.log 2&gt; /var/log/selenium/selenium-error.log &amp; <span class="nb">echo</span> <span class="nv">$!</span> &gt; /tmp/selenium.pid
                    <span class="nb">echo</span> <span class="s2">"Starting Selenium..."</span>
        
                    <span class="nv">error</span><span class="o">=</span><span class="nv">$?</span>
                    <span class="k">if </span><span class="nb">test</span> <span class="nv">$error</span> -gt 0
                    <span class="k">then
                        </span><span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">bon</span><span class="k">}</span><span class="s2">Error </span><span class="nv">$error</span><span class="s2">! Couldn't start Selenium!</span><span class="k">${</span><span class="nv">boff</span><span class="k">}</span><span class="s2">"</span>
                    echo_success
                    <span class="k">fi
                fi</span>
            <span class="p">;;</span>
            <span class="s1">'stop'</span><span class="p">)</span>
                <span class="k">if </span><span class="nb">test</span> -f /tmp/selenium.pid
                <span class="k">then
                    </span><span class="nb">echo</span> <span class="s2">"Stopping Selenium..."</span>
                    <span class="nv">PID</span><span class="o">=</span><span class="sb">`</span>cat /tmp/selenium.pid<span class="sb">`</span>
                    <span class="nb">kill</span> -3 <span class="nv">$PID</span>
                    <span class="k">if </span><span class="nb">kill</span> -9 <span class="nv">$PID</span> ;
                        <span class="k">then
                            </span>sleep 2
                            <span class="nb">test</span> -f /tmp/selenium.pid <span class="o">&amp;&amp;</span> rm -f /tmp/selenium.pid
                        <span class="k">else
                            </span><span class="nb">echo</span> <span class="s2">"Selenium could not be stopped..."</span>
                        <span class="k">fi
                else
                    </span><span class="nb">echo</span> <span class="s2">"Selenium is not running."</span>
                <span class="k">fi</span>
                <span class="p">;;</span>
            <span class="s1">'restart'</span><span class="p">)</span>
               <span class="k">if </span><span class="nb">test</span> -f /tmp/selenium.pid
                <span class="k">then
                    </span><span class="nb">kill</span> -HUP <span class="sb">`</span>cat /tmp/selenium.pid<span class="sb">`</span>
                    <span class="nb">test</span> -f /tmp/selenium.pid <span class="o">&amp;&amp;</span> rm -f /tmp/selenium.pid
                    sleep 1
                    java -jar /usr/local/lib/selenium/selenium-server-standalone-2.4.0.jar -port 4444 &gt; /var/log/selenium/selenium-output.log 2&gt; /var/log/selenium/selenium-error.log &amp; <span class="nb">echo</span> <span class="nv">$!</span> &gt; /tmp/selenium.pid
                    <span class="nb">echo</span> <span class="s2">"Reload Selenium..."</span>
                <span class="k">else
                    </span><span class="nb">echo</span> <span class="s2">"Selenium isn't running..."</span>
                <span class="k">fi</span>
                <span class="p">;;</span>
            <span class="k">*</span><span class="p">)</span>      <span class="c"># no parameter specified</span>
                <span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$SELF</span><span class="s2"> start|stop|restart|reload|force-reload|status"</span>
                <span class="nb">exit </span>1
            <span class="p">;;</span>
        <span class="k">esac</span>
        
        </pre>
        
        <p>Запуск процесса:</p>
        
        <pre class="highlight shell">chmod +x /etc/init.d/selenium
        chkconfig selenium on
        service selenium start
        
        </pre>
        
        <p>Подключение FireFox:</p>
        
        <pre class="highlight shell"><span class="nb">cd</span> /tmp
        wget http://mirror.informatik.uni-mannheim.de/pub/mirrors/mozilla.org/firefox/releases/6.0/linux-i686/en-US/firefox-6.0.tar.bz2
        tar xvf firefox-6.0.tar.bz2
        mv firefox /usr/local/firefox-6.0
        ln -s /usr/local/firefox-6.0/firefox /usr/local/bin/firefox
        
        </pre>
        
        <h3 id="section-1">Результат</h3>
        
        <p>Пример скрипта:</p>
        
        <pre class="highlight ruby"><span class="nb">require</span> <span class="s1">'rubygems'</span>
        <span class="n">gem</span> <span class="s2">"selenium-client"</span>
        <span class="nb">require</span> <span class="s2">"selenium/client"</span>
        <span class="vi">@selenium_driver</span> <span class="o">=</span> <span class="no">Selenium</span><span class="o">::</span><span class="no">Client</span><span class="o">::</span><span class="no">Driver</span><span class="p">.</span><span class="nf">new</span> <span class="p">\</span>
          <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">"localhost"</span><span class="p">,</span>
          <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="mi">4444</span><span class="p">,</span>
          <span class="ss">:browser</span> <span class="o">=&gt;</span> <span class="s2">"*firefox"</span><span class="p">,</span>
          <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="s2">"http://html5test.com/"</span><span class="p">,</span>
          <span class="ss">:timeout_in_seconds</span> <span class="o">=&gt;</span> <span class="mi">10</span>
        <span class="vi">@selenium_driver</span><span class="p">.</span><span class="nf">start_new_browser_session</span>
        <span class="vi">@selenium_driver</span><span class="p">.</span><span class="nf">open</span> <span class="s2">"/"</span>
        <span class="vi">@selenium_driver</span><span class="p">.</span><span class="nf">capture_entire_page_screenshot</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="kp">__FILE__</span><span class="p">))</span> <span class="o">+</span> <span class="s1">'screenshot.png'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="vi">@selenium_driver</span><span class="p">.</span><span class="nf">stop</span>
        
        </pre>
        
        <pre class="highlight shell">gem install selenium-client
        ruby test.rb
        </pre>
        
        <h3 id="section-2">Резюме</h3>
        
        <p>Серверный selenium легко подключается к rspec и либо CI. Предоставляет больший выбор браузеров, нежели phantomjs.</p>
        
        <p>Стоит сразу посмотреть <a href="http://selenium-grid.seleniumhq.org/.">Selenium Grid</a>
        Он предназначен для распределенного по нескольким серверам тестирования.</p>
        <h4 class='meta'>
          <div class='tags'>
            <a href="/dev/tags/тестирование/">тестирование</a>
          </div>
        </h4>
        <div id='disqus_thread'></div>
        <script>
          var disqus_shortname = 'artursabirovru'; // required: replace example with your forum shortname
          
          //var disqus_identifier = 'unique_dynamic_id_1234';
          var disqus_url = 'http://artursabirov.ru//2011/08/20/selenium-server';
          
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript';
              dsq.async = true; dsq.defer = 'defer';
              dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      </article>
    </section>
    <script>
      var disqus_shortname = 'artursabirovru';
      (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
      
      
      var addthis_config = {
          pubid: "ra-4e4f7ce25d6f5675",
          data_track_clickback: true,
          ui_language: "ru",
          templates: {twitter: '{{text}} {{lurl}}'},
          data_ga_tracker: "UA-24946626-1"
      };
    </script>
    <script defer="defer" type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4e4f7ce25d6f5675&domready=1"></script>
    <script src="/javascripts/application.js" type="text/javascript"></script>
  </body>
</html>

