<!DOCTYPE html>
<html dir='ltr' lang='ru-RU'>
  <head>
    <meta charset='utf-8'>
    <title>PostgreSQL 9.0 High Performance</title>
    <link href='http://feeds.feedburner.com/artursabirov' rel='alternate' title='ArturSabirov.ru' type='application/rss+xml'>
    <link href="/stylesheets/blog.css" media="screen" rel="stylesheet" type="text/css" />
    <meta content='width=device-width, initial-scale=1.0' name='viewport'>
    <script charset='windows-1251' src='http://vkontakte.ru/js/api/openapi.js?29' type='text/javascript'></script>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="http://feeds.feedburner.com/artursabirov//dev" />
    <script>
      VK.init({apiId: 2348265, onlyWidgets: true});
    </script>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-24946626-1']);
      _gaq.push(['_trackPageview']);
      
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <header>
      <section>
        <h1 id='page_heading'>
          <a href='/'>Блог Артура Сабирова</a>
        </h1>
        <nav>
          <a href="/dev">Разработка</a>
          <a href="/projects">Проекты</a>
          <a href="/books">Обзор книг</a>
          <a href="/life">Жизнь</a>
          <a href="/about">О себе</a>
        </nav>
      </section>
    </header>
    <section id='single-column'>
      <article>
        <h1>PostgreSQL 9.0 High Performance</h1>
        <p>Читая книгу <a href="http://www.goodreads.com/book/show/10033368-postgresql-9-0-high-performance,">PostgreSQL 9.0 High Performance</a>&#x000A;выписал некоторые интересные моменты, которые могут оказаться полезными простым разработчикам.</p>&#x000A;&#x000A;<h2 id="section">Полезные команды.</h2>&#x000A;&#x000A;<p>EXPLAIN ANALYZE [sql] — анализ выполненного запроса (используемые ноды, время выполнения, использование индексов).</p>&#x000A;&#x000A;<p>VACUUM — дефрагментация базы. Можно запускать, если отключен autovacuum. Рекомендуется выполнять после большого удаления данных.</p>&#x000A;&#x000A;<p>REINDEX INDEX [index_name] — перестройка индекса.</p>&#x000A;&#x000A;<p>REINDEX TABLE [table_name] — перестройка индексов всей таблицы.</p>&#x000A;&#x000A;<h2 id="section-1">Анализаторы логов</h2>&#x000A;&#x000A;<ul>&#x000A;  <li><a href="http://pgfouine.projects.postgresql.org/,">pgFouine</a></li>&#x000A;  <li><a href="http://bucardo.org/wiki/Pgsi,">pgsi</a></li>&#x000A;  <li><a href="http://www.maatkit.org/doc/mk-query-digest.html">mk-query-digest</a></li>&#x000A;</ul>&#x000A;&#x000A;<p>pgFouine — наиболее удобный, хоть и требует веб-сервер для запуска.</p>&#x000A;&#x000A;<h2 id="section-2">Рекомендации по использованию индексов</h2>&#x000A;&#x000A;<p>Ставьте индексы на поля, по которым происходит поиск или сортировка.</p>&#x000A;&#x000A;<p>Исключите использование ненужных индексов (найти их поможет EXPLAIN ANALYZE)</p>&#x000A;&#x000A;<h2 id="section-3">Индексы</h2>&#x000A;&#x000A;<p>B-Tree – индекс по-умолчанию. Подходит для всех типов.</p>&#x000A;&#x000A;<p>Hash — эффективен при поиске по равенству: column_name = 'value'.</p>&#x000A;&#x000A;<p>GIN — дает быстрый поиск, но долгое обновление при INSERT. Применим для полнотекстового поиска.</p>&#x000A;&#x000A;<p>GiST — для полнотекстового поиска. Быстрый поиск, но долгое обновление индекса. Так же применим для полнотекстового поиска.</p>&#x000A;&#x000A;<p>При поиске с использованием LIKE или POSIX задать специальный параметр: </p>&#x000A;&#x000A;<pre class="highlight sql"><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">index_name</span> <span class="k">ON</span> <span class="k">table_name</span><span class="p">(</span><span class="k">column_name</span> <span class="n">varchar_pattern_ops</span><span class="p">);</span>&#x000A;</pre>&#x000A;<p>Для других типов: text_pattern_ops, bpchar_pattern_ops, name_pattern_ops.</p>&#x000A;&#x000A;<h2 id="section-4">Составной индекс</h2>&#x000A;&#x000A;<p>При поиске по по двум и более колонкам можно использовать составной индекс:</p>&#x000A;&#x000A;<pre class="highlight sql"><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">index_name</span> <span class="k">ON</span> <span class="k">table_name</span><span class="p">(</span><span class="n">col_1</span><span class="p">,</span> <span class="n">col_2</span><span class="p">);</span>&#x000A;</pre>&#x000A;&#x000A;<h2 id="section-5">Частичный индекс</h2>&#x000A;&#x000A;<p>В случае, если поиск совершается только по какому-то одному значению:</p>&#x000A;&#x000A;<pre class="highlight sql"><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">index_name</span> <span class="k">ON</span> <span class="k">table</span> <span class="n">name</span> <span class="k">WHERE</span> <span class="k">column_name</span> <span class="k">IS</span> <span class="n">value</span><span class="p">;</span>&#x000A;</pre>&#x000A;&#x000A;<h2 id="section-6">Сортировка индексов</h2>&#x000A;&#x000A;<p>При сортировке по индексу в одну сторону, например DESC, можно настроить и сам индекс:</p>&#x000A;&#x000A;<pre class="highlight sql"><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">index_name</span> <span class="k">ON</span>  <span class="k">table_name</span><span class="p">(</span><span class="k">column_name</span> <span class="k">DESC</span><span class="p">);</span>&#x000A;</pre>&#x000A;&#x000A;<p>Если имеются значения NULL, можно подвинуть их в начало:</p>&#x000A;&#x000A;<pre class="highlight sql"><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">index_name</span> <span class="k">ON</span>  <span class="k">table_name</span><span class="p">(</span><span class="k">column_name</span> <span class="n">NULLS</span> <span class="k">FIRST</span><span class="p">);</span>&#x000A;</pre>&#x000A;&#x000A;<p>По умолчанию значения NULL хранятся в конце.</p>&#x000A;&#x000A;<h2 id="section-7">Обработка значений в индексе</h2>&#x000A;&#x000A;<p>Если в запросах используются функции:</p>&#x000A;&#x000A;<pre class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="k">table_name</span> <span class="k">WHERE</span> <span class="k">lower</span><span class="p">(</span><span class="k">column_name</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'x'</span><span class="p">;</span>&#x000A;</pre>&#x000A;&#x000A;<p>Можно подготовить значения и в самом индексе:</p>&#x000A;&#x000A;<pre class="highlight sql"><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">index_name</span> <span class="k">ON</span> <span class="k">table_name</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="k">column_name</span><span class="p">));</span> &#x000A;</pre>&#x000A;&#x000A;<h2 id="offset-0">OFFSET 0</h2>&#x000A;&#x000A;<p>Использование «OFFSET 0» ускорит выполнение вложенных запросов:</p>&#x000A;&#x000A;<pre class="highlight sql"><span class="k">SELECT</span> <span class="n">l</span><span class="p">.</span><span class="n">prod_id</span> <span class="k">FROM</span> <span class="n">orderlines</span> <span class="n">l</span>&#x000A;<span class="k">WHERE</span> <span class="k">EXISTS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">JOIN</span> <span class="n">orders</span> <span class="k">USING</span> <span class="p">(</span><span class="n">customerid</span><span class="p">)</span> <span class="k">WHERE</span> <span class="n">orders</span><span class="p">.</span><span class="n">orderid</span> <span class="o">=</span> <span class="n">l</span><span class="p">.</span><span class="n">orderid</span> <span class="k">OFFSET</span> <span class="mi">0</span><span class="p">)</span>&#x000A;<span class="k">AND</span> <span class="n">l</span><span class="p">.</span><span class="n">orderdate</span><span class="o">=</span><span class="s1">'2004-12-01'</span><span class="p">;</span>&#x000A;</pre>&#x000A;&#x000A;<h2 id="select-count">Ускорение SELECT count(*)</h2>&#x000A;&#x000A;<p>В PostgreSQL, в отличии от других БД, медленный подсчет строк.</p>&#x000A;&#x000A;<pre class="highlight sql"><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>  <span class="k">FROM</span> <span class="n">t</span><span class="p">;</span>&#x000A;</pre>&#x000A;&#x000A;<p>Его можно ускорить, добавив какое-нибудь условие WHERE:</p>&#x000A;&#x000A;<pre class="highlight sql"><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">t</span> <span class="k">WHERE</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">10</span> <span class="k">and</span> <span class="n">k</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">;</span>&#x000A;</pre>&#x000A;&#x000A;<h2 id="foreign-keys">FOREIGN KEYS</h2>&#x000A;&#x000A;<p>Добавление и изменение большого количества данных может оказаться медленным из-за использования внешних ключей (FOREIGN KEYS). Поэтому их можно  приглушить до окончания операции:</p>&#x000A;&#x000A;<pre class="highlight sql"><span class="k">BEGIN</span><span class="p">;</span>&#x000A;<span class="k">SET</span> <span class="k">CONSTRAINTS</span> <span class="k">ALL</span> <span class="k">DEFERRED</span><span class="p">;</span>&#x000A;<span class="p">[</span><span class="k">update</span> <span class="k">or</span> <span class="k">insert</span> <span class="n">statements</span><span class="p">]</span>&#x000A;<span class="k">COMMIT</span><span class="p">;</span>&#x000A;</pre>
        <h4 class='meta'>
          <div class='tags'>
            <a href="/dev/tags/postgresql/">postgresql</a>
          </div>
        </h4>
        <div id='disqus_thread'></div>
        <script>
          var disqus_shortname = 'artursabirovru'; // required: replace example with your forum shortname
          
          //var disqus_identifier = 'unique_dynamic_id_1234';
          var disqus_url = 'http://artursabirov.ru//2012/04/08/postgres-high-perfomance';
          
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript';
              dsq.async = true; dsq.defer = 'defer';
              dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      </article>
    </section>
    <script>
      var disqus_shortname = 'artursabirovru';
      (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
      
      
      var addthis_config = {
          pubid: "ra-4e4f7ce25d6f5675",
          data_track_clickback: true,
          ui_language: "ru",
          templates: {twitter: '{{text}} {{lurl}}'},
          data_ga_tracker: "UA-24946626-1"
      };
    </script>
    <script defer="defer" type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4e4f7ce25d6f5675&domready=1"></script>
    <script src="/javascripts/application.js" type="text/javascript"></script>
  </body>
</html>

